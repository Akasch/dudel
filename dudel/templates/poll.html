{% extends "base_poll.html" %}

{% block polltitle %}{% endblock %}

{% macro pollDetail(title, content, icon) %}
    <li>
        <span class="title">{{ title }}</span> 
        <i class="fa fa-{{ icon }}"></i> 
        <span class="content">{{ content }}</span>
    </li>
{% endmacro %}

{% block poll_content %}
    <ul class="poll-details well row">
        <div class="col-md-4">
        {{ pollDetail("Created on", poll.created|date, "calendar") }}

        {{ pollDetail("Expires", poll.due_date|date if poll.due_date else "never", "clock-o") }} 
        </div>
        <div class="col-md-4">

        {{ pollDetail("Ownership", ("you" if poll.author == current_user else poll.author.displayname) if poll.author else "unclaimed", "briefcase") }} 
        {{ pollDetail("Anonymous voting", "allowed" if poll.anonymous_allowed else "disabled", "exclamation") }}
        </div>
        <div class="col-md-4">
        {{ pollDetail("Public listing", "visible" if poll.public_listing else "hidden", "list") }}
        {{ pollDetail("Login required", "yes" if poll.public_listing else "no", "user") }}
        </div>
    </ul>

    {% if poll.description %}
        <h3>Poll Description</h3>
        {{ poll.description | markdown }}
        <hr />
    {% endif %}

    {% if poll.votes %}
        <div class="table-padding">
            {% set groups = poll.get_choice_groups() %}
            <div class="table-responsive table-scroll">
                <table class="table poll auto-width">
                    <thead>
                        {% if groups|length>1 or poll.type == "date" %}
                        <tr>
                            <th></th>
                            {% for group in groups %}
                                <th colspan="{{ group|length }}" class="choice-group">
                                    {{ group[0].group|date if poll.type=="date" else group[0].group }}
                                </th>
                            {% endfor %}
                        </tr>
                        {% endif %}
                        <tr>
                            <th></th>
                            {% for group in groups %}
                                {% for choice in group %}
                                    <th class="choice-text">
                                        {{ choice.text or choice.date|time }}
                                    </th>
                                {% endfor %}
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for vote in poll.votes %}
                            <tr{% if not current_user.is_anonymous() and vote.user == current_user %} class="mine"{% endif %}>
                                <td class="author">
                                    {% if vote.anonymous %}
                                        anonymous
                                    {% else %}
                                        {{ vote.name or vote.user.displayname }}
                                    {% endif %}
                                </td>
                                {% for group in groups %}
                                    {% for choice in group %}
                                        {% set vote_choice = poll.get_vote_choice(vote, choice) %}
                                        {% if vote_choice and not vote_choice.value.deleted %}
                                        <td class="vote-choice text-center {{ '' if vote_choice.value else 'none' }} {{ 'comment' if vote_choice.comment else '' }}" style="background-color: #{{ vote_choice.value.color }}"{% if vote_choice.comment %} title="{{ vote_choice.comment }}"{% endif %}>
                                            <span class="fa fa-{{ vote_choice.value.icon if vote_choice.value else 'question' }}"></span>
                                            {#{% if vote_choice.comment %}<span class="comment-icon fa fa-exclamation"></span>{% endif %}#}
                                        </td>
                                        {% else %}
                                        <td class="vote-choice text-center none">
                                            <span class="fa fa-question"></span>
                                        </td>
                                        {% endif%}
                                    {% endfor %}
                                {% endfor %}
                                <td>
                                    <a href="{{ url_for('poll_vote_edit', slug=poll.slug, vote_id=vote.id) }}" class="btn btn-xs btn-default"><i class="fa fa-edit"></i></a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            {% set stats = poll.get_statistics() %}
                            {% set total = poll.votes|length %}
                            <th></th>
                            {% for group in groups %}
                                {% for choice in group %}
                                    {% set stat = stats[choice] %}
                                    <th class="choice-sum {% if stat["max"] %}maximum{% endif %}" title="{% for value in poll.get_choice_values() %}{{ stat[value.title] }} {{ value.title }}{% if not loop.last %}, {% endif %}{% endfor %}">
                                        {{ "%2.0f" % (stat["yes"]/total*100) }}%
                                    </th>
                                {% endfor %}
                            {% endfor %}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    {% else %}
        <p class="text-muted text-center">No-one voted yet. Be the first!</p>
    {% endif %}

    <div style="clear: right;"></div>

    <center>
        {% set user_votes = [] if current_user.is_anonymous() else poll.get_user_votes(current_user) %}
        {% if poll.one_vote_per_user and user_votes %}
            <p><a class="btn btn-lg btn-primary" href="{{ url_for('poll_vote_edit', slug=poll.slug, vote_id=user_votes[0].id) }}" style="min-width: 30%;">Edit vote</a></p>
        {% elif poll.require_login and current_user.is_anonymous() %}
            <p><a class="btn btn-lg btn-primary" href="{{ url_for('login', next=url_for('poll_vote', slug=poll.slug)) }}" style="min-width: 30%;">Log in to vote</a></p>
        {% else %}
            <p><a class="btn btn-lg btn-success" href="{{ url_for('poll_vote', slug=poll.slug) }}" style="min-width: 30%;">Vote now</a></p>
        {% endif %}
    </center>


    {% set comments = poll.get_comments() %}

    {% if comments %}
        <hr />
        <h3>Comments</h3>
        <div class="comments">
        {% for comment in comments %}
            <div class="comment">
                <a name="comment-{{ comment.id }}"></a>
                <div class="avatar">
                    <img src="{{ (comment.name or comment.user.email) | gravatar }}" />
                </div>
                <div class="meta">
                    <div class="author">{{ comment.name or comment.user.displayname }}</div>
                    commented on
                    <div class="date">{{ comment.created | date }} at {{ comment.created | time }}</div>
                </div>
                <div class="text">{{ comment.text | markdown }}</div>
            </div>
        {% endfor %}
        </div>
    {% endif %}

    {% if poll.allow_comments %}
        <hr />
        <h3>Post a comment</h3>
        <form method="POST" class="form">
            {{ comment_form.hidden_tag() }}
            <div class="form-group">
                {{ comment_form.name.label }}
                {% if current_user.is_anonymous() %}
                    {{ comment_form.name(class="form-control") }}
                {% else %}
                    <input type="text" disabled="DISABLED" value="{{ current_user.displayname }}" class="form-control" />
                {% endif %}
                {{ field_error(comment_form.name) }}
            </div>
            <div class="form-group">
                {{ comment_form.text.label }}
                {{ comment_form.text(class="form-control", rows=6) }}
                {{ field_error(comment_form.text) }}
                {{ markdown_info(true) }}
            </div>
            <div class="form-group">
                <input type="submit" value="Post comment" class="btn btn-primary" />
            </div>
        </form>
    {% endif %}
{% endblock %}
