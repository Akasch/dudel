{% extends "base.html" %}
{% from "_formhelpers.html" import form_errors %}

{% block content %}

    <div class="page-header">
        <h1 class="inline">
            {{ poll.title }}
            <small>Edit choices</small>
        </h1>
        <div class="pull-right">
        <a href="{{ url_for('poll_edit', slug=poll.slug) }}" class="btn btn-default"><span class="icon-wrench"></span> Settings</a>
        <a href="{{ poll.get_url() }}" class="btn btn-default"><span class="icon-search"></span> Show poll</a>
        </div>
    </div>

    {% if poll.type == "normal" %}
        {% if poll.get_choices()|length != poll.choices|length %}
        <p class="alert alert-info">
            Deleted choices will stay in this list, so votes that have already been
            made are not lost.
        </p>
        {% endif %}

        <form class="form" method="POST">
            {{ form.hidden_tag() }}
            {{ form_errors(form) }}
            <table class="table auto-width">
                <tr>
                    <th>Choice</th>
                    <th>Votes cast</th>
                    <th>Actions</th>
                </tr>
                {% set total_votes = poll.votes|length %}
                {% for choice in poll.choices|sort() %}
                    <tr class="choice {% if choice.deleted %}deleted{% endif %}">
                        <td class="choice">{{ choice.text }}</td>
                        {% set vote_count = choice.vote_choices|length %}
                        <td class="color {{ 'green' if vote_count >= total_votes else ('red' if vote_count == 0 else 'orange') }}">
                            <strong>{{ vote_count }}</strong> / {{ total_votes }}
                        </td>
                        <td><a href="?toggle={{ choice.id }}" class="btn btn-default btn-xs">
                            {% if choice.deleted %}
                                <i class="icon-undo"></i>
                            {% else %}
                                <i class="icon-trash"></i>
                            {% endif %}
                        </a></td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="2">{{ form.text(class="form-control input-sm", placeholder="Add a choice") }}</td>
                    <td><input type="submit" value="Add" class="btn btn-default btn-sm" /></td>
                </tr>
            </table>
        </form>
    {% elif poll.type == "date" %}
        {% if step == 1 %}

            <p>Please add the dates and times you want to allow to these
                lists. In the next step, you will be asked to select which time
                is available at which date.</p>

<!--             <noscript>
                <p class="alert alert-warning">
                    It's a pity you don't have <b>JavaScript</b> turned on, so you'll have
                    to type in comma separated values in the correct format yourself,
                    no spaces allowed. Or just stop being paranoid and enable
                    JavaScript on this site. You'll get a certainly fancy interface
                    for date and time input...
                </p>
            </noscript>
 -->
            <div class="row script-only">
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Selected dates
                        </div>
                        <div class="panel-body">

                    <div class="calendar script-only" data-calendar-field="#date">
                        <table class="table auto-width">
                            <tr>
                                <th><button class="prev-month btn btn-default btn-xs">&laquo;</button></th>
                                <th class="title" colspan="5">monthname</th>
                                <th><button class="next-month btn btn-default btn-xs">&raquo;</button></th>
                            </tr>
                            <tr><td>Mo</td><td>Tu</td><td>We</td><td>Th</td><td>Fr</td><td>Sa</td><td>Su</td></tr>
                            <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                            <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                            <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                            <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                            <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                        </table>
                    </div>

                    <script>
                        var ENABLED_DATES = [{% for date in dates %}"{{ date }}", {% endfor %}];
                        var CURRENT_DATE = "{{ request.form.get('date') or '' }}";
                    </script>

                    <ul class="calendar-list">
                        {% for date in dates %}
                            <li><a href="#" class="btn btn-default">{{ date|date }}</a></li>
                        {% endfor %}
                    </ul>
                    <span class="help-block">Click a date to remove it</span>

                    <div id="date-form">
                        <h2>Add another date</h2>
                        <form class="form" method="POST">
                            {{ date_form.hidden_tag() }}
                            {{ form_errors(date_form) }}
                            <div class="form-group">
                                {{ date_form.date.label }}
                                {{ date_form.date(class="form-control") }}
                            </div>
                            <div class="form-group">
                                <input type="submit" value="Add date" class="btn btn-default" />
                            </div>
                        </form>
                    </div>

                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Selected time slots
                        </div>
                        <div class="panel-body">

                    <div class="time-input">
                        <div id="time-slider">
                            <div id="time-slider-knob">
                            </div>
                        </div>

                        <div class="time-slider-display">
                            <div class="hour"></div>
                            <div class="minute"></div>
                        </div>

                        <form class="form-inline" id="time-slider-form" method="POST">
                            {{ time_form.hidden_tag() }}
                            {{ form_errors(time_form) }}
                            {{ time_form.hour(id="time-hour", class="form-control", placeholder="HH") }}
                            {{ time_form.minute(id="time-minute", class="form-control", placeholder="MM") }}
                            <input type="submit" value="Add" class="btn btn-default" style="height: 3.4em;" />
                        </form>
                    </div>

                    <ul class="time-slots">
                        {% for time in times %}
                            <li><input type="button" class="btn btn-default time-remove-button" value="{{ time|time }}" /></li>
                        {% endfor %}
                    </ul>
                    <span class="help-block">Click a time slot to remove it</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <a href="{{ url_for('poll_edit_choices', slug=poll.slug, step=2) }}" class="btn btn-primary">Next</a>
            </div>


        {% elif step == 2 %}
            <p>Here you can select which date and time combinations are available for voting.</p>

            <form class="form form-inline" method="POST">
                <table class="table auto-width poll">
                    <tr>
                        <th></th>
                        {% for time in times %}
                        <th class="choice-text">{{ time|time }}</th>
                        {% endfor %}
                    </tr>
                {% for date in dates %}
                    {% set dateloop = loop %}
                    <tr>
                        <th class="choice-text">{{ date|date }}</th>
                        {% for time in times %}
                        <td class="checkbox-cell">
                            <input type="checkbox" name="datetimes[]" value="{{date}} {{time}}"{% if poll.has_choice_date_time(date, time) %} checked="CHECKED"{% endif %} />
                        </td>
                        {% endfor %}
                        <td class="choice-text">
                            <input type="button" class="btn btn-xs toggle toggle-select   toggle-row" value="all" />
                            <input type="button" class="btn btn-xs toggle toggle-deselect toggle-row" value="none" />
                        </td>
                    </tr>
                {% endfor %}
                    <tr>
                        <td></td>
                        {% for time in times+[0] %}
                        <td class="choice-text">
                            <input type="button" class="btn btn-block btn-xs toggle toggle-select   toggle-{{ 'all' if loop.last else 'column' }}" value="all" />
                            <input type="button" class="btn btn-block btn-xs toggle toggle-deselect toggle-{{ 'all' if loop.last else 'column' }}" value="none" />
                        </td>
                        {% endfor %}

                        <td></td>
                    </tr>
                </table>

                <div class="form-actions">
                    <a href="{{ url_for('poll_edit_choices', slug=poll.slug, step=1) }}" class="btn btn-default">Back</a>
                    <input type="submit" value="Save" class="btn btn-primary" />
                </div>

            </form>
        {% endif %}
    {% endif %}
{% endblock %}
