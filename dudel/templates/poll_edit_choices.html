{% extends "base_poll.html" %}
{% from "_formhelpers.html" import form_errors %}

{% block title %}{{ poll.title }} <small>Edit choices</small>{% endblock %}

{% block foot %}
    <script src="{{ url_for('static', filename='js/poll_edit_choices.js') }}" type="text/javascript" lang="javascript"></script>
{% endblock %}

{% block poll_content %}
    {% if poll.type == "normal" %}
        {% if poll.get_choices()|length != poll.choices|length %}
        <p class="alert alert-info">
            Deleted choices will stay in this list, so votes that have already been
            made are not lost.
        </p>
        {% endif %}

        <form class="form" method="POST">
            {{ form.hidden_tag() }}
            {{ form_errors(form) }}
            <table class="table auto-width">
                <tr>
                    <th>Choice</th>
                    <th>Votes cast</th>
                    <th>Actions</th>
                </tr>
                {% set total_votes = poll.votes|length %}
                {% for choice in poll.choices|sort() %}
                    <tr class="choice {% if choice.deleted %}deleted{% endif %}">
                        <td class="choice">{{ choice.text }}</td>
                        {% set vote_count = choice.vote_choices|length %}
                        <td class="color {{ 'green' if vote_count >= total_votes else ('red' if vote_count == 0 else 'orange') }}">
                            <strong>{{ vote_count }}</strong> / {{ total_votes }}
                        </td>
                        <td><a href="?toggle={{ choice.id }}" class="btn btn-default btn-xs">
                            {% if choice.deleted %}
                                <i class="icon-undo"></i>
                            {% else %}
                                <i class="icon-trash"></i>
                            {% endif %}
                        </a></td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="2">{{ form.text(class="form-control input-sm", placeholder="Add a choice") }}</td>
                    <td><input type="submit" value="Add" class="btn btn-default btn-sm" /></td>
                </tr>
            </table>
        </form>
    {% elif poll.type == "date" %}
        {% if step == 1 %}

            <p class="alert alert-info">Please add the dates and times you want to allow to these
                lists. In the next step, you will be asked to select which time
                is available at which date.</p>

            <noscript>
                <p class="alert alert-warning">
                    It's a pity you don't have <b>JavaScript</b> turned on, so you'll have
                    to type in comma separated values in the correct format yourself,
                    no spaces allowed. Or just stop being paranoid and enable
                    JavaScript on this site. You'll get a certainly fancy interface
                    for date and time input...
                </p>
            </noscript>

            <form method="POST" id="date-time-form" action="{{ url_for('poll_edit_choices', slug=poll.slug, step=2) }}" >
                <div id="date-time-form-content">
                    {{ form.hidden_tag() }}
                    {{ form_errors(form) }}
                    <div class="form-group">
                        {{ form.dates.label }}
                        {{ form.dates(class="form-control") }}
                    </div>
                    <div class="form-group">
                        {{ form.times.label }}
                        {{ form.times(class="form-control") }}
                    </div>
                </div>

                <div class="script-only">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    Selected dates
                                </div>
                                <div class="panel-body">
                                    <div id="calendar" class="calendar" data-calendar-field="#date">
                                        <table class="table auto-width">
                                            <tr>
                                                <th><button id="calendar-prev-month" class="btn btn-default btn-xs">&laquo;</button></th>
                                                <th class="title" colspan="5">monthname</th>
                                                <th><button id="calendar-next-month" class="btn btn-default btn-xs">&raquo;</button></th>
                                            </tr>
                                            <tr><td>Mo</td><td>Tu</td><td>We</td><td>Th</td><td>Fr</td><td>Sa</td><td>Su</td></tr>
                                            <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                                            <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                                            <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                                            <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                                            <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                                        </table>
                                    </div>

                                    <ul class="calendar-list"></ul>

                                    <span class="help-block">Click a date to add/remove it</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    Selected time slots
                                </div>
                                <div class="panel-body">

                            <div class="time-input">
                                <div id="time-slider">
                                    <div id="time-slider-knob">
                                    </div>
                                </div>

                                <div class="time-slider-display">
                                    <div class="hour"></div>
                                    <div class="minute"></div>
                                </div>

                                <div class="form-inline" id="time-slider-form">
                                    <input type="text" id="time-hour" class="form-control" placeholder="HH" />
                                    <input type="text" id="time-minute" class="form-control" placeholder="MM" />
                                    <input type="button" id="time-add-button" value="Add" class="btn btn-default" style="height: 3.4em;" />
                                </div>
                            </div>

                            <ul class="time-slots"></ul>

                            <span class="help-block">Click a time slot to remove it</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <input type="submit" value="Next" class="btn btn-primary" />
                </div>
            </form>

        {% elif step == 2 %}
            <p>Here you can select which date and time combinations are available for voting.</p>

            <form class="form form-inline" method="POST" action="{{ url_for('poll_edit_choices', slug=poll.slug, step=3) }}">
                {{ form.hidden_tag() }}
                {{ form_errors(form) }}
                {{ form.dates(hidden=True) }}
                {{ form.times(hidden=True) }}


                <table class="table auto-width poll">
                    <tr>
                        <th></th>
                        {% for time in times %}
                        <th class="choice-text">{{ time|time }}</th>
                        {% endfor %}
                    </tr>
                {% for date in dates %}
                    {% set dateloop = loop %}
                    <tr>
                        <th class="choice-text">{{ date|date }}</th>
                        {% for time in times %}
                        <td class="checkbox-cell">
                            <input type="checkbox" name="datetimes[]" value="{{date}} {{time}}"{% if poll.has_choice_date_time(date, time) %} checked="CHECKED"{% endif %} />
                        </td>
                        {% endfor %}
                        <td class="choice-text">
                            <input type="button" class="btn btn-xs toggle toggle-select   toggle-row" value="all" />
                            <input type="button" class="btn btn-xs toggle toggle-deselect toggle-row" value="none" />
                        </td>
                    </tr>
                {% endfor %}
                    <tr>
                        <td></td>
                        {% for time in times+[0] %}
                        <td class="choice-text">
                            <input type="button" class="btn btn-block btn-xs toggle toggle-select   toggle-{{ 'all' if loop.last else 'column' }}" value="all" />
                            <input type="button" class="btn btn-block btn-xs toggle toggle-deselect toggle-{{ 'all' if loop.last else 'column' }}" value="none" />
                        </td>
                        {% endfor %}

                        <td></td>
                    </tr>
                </table>

                <div class="form-actions">
                    <a href="javascript: history.back();" class="btn btn-default">Back</a>
                    <input type="submit" value="Save" class="btn btn-primary" />
                </div>

            </form>
        {% endif %}
    {% endif %}
{% endblock %}
