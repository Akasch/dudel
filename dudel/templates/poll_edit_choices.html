{% extends "base_poll.html" %}
{% from "_formhelpers.html" import form_errors, alert %}

{% block polltitle %}Choices{% endblock %}

{% block foot %}
    <script src="{{ url_for('static', filename='js/poll_edit_choices.js') }}" type="text/javascript" lang="javascript"></script>
{% endblock %}

{% block poll_content %}
    {% if poll.type == "normal" %}
        {% if poll.get_choices()|length != poll.choices|length %}
            {{ alert("info", "Deleted choices will stay in this list, so votes that have already been made are not lost.") }}
        {% endif %}

        <form class="form" method="POST">
            {{ form.hidden_tag() }}
            {{ form_errors(form) }}
            <table class="table auto-width">
                <tr>
                    <th>Choice</th>
                    <th>Votes cast</th>
                    <th>Actions</th>
                </tr>
                {% set total_votes = poll.votes|length %}
                {% for choice in poll.choices|sort() %}
                    <tr class="choice {% if choice.deleted %}deleted{% endif %}">
                        <td class="choice">{{ choice.text }}</td>
                        {% set vote_count = choice.vote_choices|length %}
                        <td class="color {{ 'green' if vote_count >= total_votes else ('red' if vote_count == 0 else 'orange') }}">
                            <strong>{{ vote_count }}</strong> / {{ total_votes }}
                        </td>
                        <td><a href="?toggle={{ choice.id }}" class="btn btn-default btn-xs">
                            {% if choice.deleted %}
                                <i class="fa fa-undo"></i>
                            {% else %}
                                <i class="fa fa-trash-o"></i>
                            {% endif %}
                        </a></td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="2">{{ form.text(class="form-control input-sm", placeholder="Add a choice") }}</td>
                    <td><input type="submit" value="Add" class="btn btn-default btn-sm" /></td>
                </tr>
            </table>
        </form>
    {% elif poll.type == "date" %}

        <div class="visible-xs visible-sm">
            <ul class="steps">
                <li{% if step == 1 %} class="current"{% endif %}><span>Step 1</span>Days</li>
                <li{% if step == 2 %} class="current"{% endif %}><span>Step 2</span>Times</li>
                <li{% if step in (3, 4) %} class="current"{% endif %}><span>Step 3</span>Combine</li>
            </ul>
        </div>

        <div class="hidden-xs hidden-sm">
            <ul class="steps">
                <li{% if step == 1 %} class="current"{% endif %}><span>Step 1</span>Select days</li>
                <li{% if step == 2 %} class="current"{% endif %}><span>Step 2</span>Select time slots</li>
                <li{% if step in (3, 4) %} class="current"{% endif %}><span>Step 3</span>Choose combinations</li>
            </ul>
        </div>

        {% if step in (1, 2) %}
            <noscript>
                <p class="alert alert-warning">
                    It's a pity you don't have <b>JavaScript</b> turned on, so you'll have
                    to type in comma separated values in the correct format yourself,
                    no spaces allowed. Or just stop being paranoid and enable
                    JavaScript on this site. You'll get a certainly fancy interface
                    for date and time input...
                </p>
            </noscript>

            <form method="POST" id="date-time-form" action="{{ url_for('poll_edit_choices', slug=poll.slug, step=step+1) }}" >
                <div id="date-time-form-content">
                    {{ form.hidden_tag() }}
                    {{ form_errors(form) }}
                    <div class="form-group">
                        {{ form.dates.label }}
                        {{ form.dates(class="form-control") }}
                    </div>
                    <div class="form-group">
                        {{ form.times.label }}
                        {{ form.times(class="form-control") }}
                    </div>
                </div>

                {% if step == 1 %}
                <div class="script-only">
                    <div class="row">
                        <div class="col-md-4">
                            <div id="calendar" class="calendar" data-calendar-field="#date">
                                <table class="table auto-width">
                                    <tr>
                                        <th><button id="calendar-prev-month" class="btn btn-default btn-xs">&laquo;</button></th>
                                        <th class="title" colspan="5">monthname</th>
                                        <th><button id="calendar-next-month" class="btn btn-default btn-xs">&raquo;</button></th>
                                    </tr>
                                    <tr><td>Mo</td><td>Tu</td><td>We</td><td>Th</td><td>Fr</td><td>Sa</td><td>Su</td></tr>
                                    <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                                    <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                                    <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                                    <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                                    <tr class="week"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="calendar-list">
                                {{ alert("info", "Please select the days that you want to be able to choose.
                                    In the next step, you will select time slots.") }}

                                <h2>Selected days</h2>
                                <ul id="calendar-list"></ul>
                            </div>
                        </div>
                    </div>

                </div>
                {% endif %}

                {% if step == 2 %}
                <div class="script-only">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="time-input">
                                <div id="time-slider">
                                    <div id="time-slider-knob">
                                    </div>
                                </div>

                                <div class="time-slider-display">
                                    <div class="hour"></div>
                                    <div class="minute"></div>
                                </div>

                                <div class="form-inline" id="time-slider-form">
                                    <input type="text" id="time-hour" class="form-control" placeholder="HH" />
                                    <input type="text" id="time-minute" class="form-control" placeholder="MM" />
                                    <input type="button" id="time-add-button" value="Add" class="btn btn-default" style="height: 3.4em;" />
                                </div>
                            </div>
                        </div>

                        <div class="calendar-list col-md-7">
                            {{ alert("info", "Please select the time slots that you want to be able 
                                to choose. In the next step, you will match them against 
                                the selected days.") }}

                            <h2>Selected time slots</h2>
                            <ul class="time-slots"></ul>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="form-actions">
                    <a href="javascript: history.back();" class="btn btn-default">Back</a>
                    <input type="submit" value="Next" class="btn btn-primary" />
                </div>
            </form>

        {% elif step in (3, 4) %}
            {{ alert("info", "Here you can select which day/time combinations are available for voting.") }}

            <form class="form form-inline" method="POST" action="{{ url_for('poll_edit_choices', slug=poll.slug, step=4) }}">
                {{ form.hidden_tag() }}
                {{ form_errors(form) }}
                {{ form.dates(hidden=True) }}
                {{ form.times(hidden=True) }}


                <div class="table-responsive" style="margin-bottom: 1em;">
                    <table class="table auto-width poll">
                        <tr>
                            <th></th>
                            {% for time in times %}
                            <th class="choice-text">{{ time|time }}</th>
                            {% endfor %}
                        </tr>
                    {% for date in dates %}
                        {% set dateloop = loop %}
                        <tr>
                            <th class="choice-text">{{ date|date }}</th>
                            {% for time in times %}
                            <td class="checkbox-cell">
                                <input type="checkbox" name="datetimes[]" value="{{date}} {{time}}"{% if poll.has_choice_date_time(date, time) %} checked="CHECKED"{% endif %} />
                            </td>
                            {% endfor %}
                            <td class="choice-text">
                                <input type="button" class="btn btn-xs btn-link toggle toggle-select   toggle-row" value="all" />
                                <input type="button" class="btn btn-xs btn-link toggle toggle-deselect toggle-row" value="none" />
                            </td>
                        </tr>
                    {% endfor %}
                        <tr>
                            <td></td>
                            {% for time in times+[0] %}
                            <td class="choice-text">
                                <input type="button" class="btn btn-block btn-xs btn-link toggle toggle-select   toggle-{{ 'all' if loop.last else 'column' }}" value="all" />
                                <input type="button" class="btn btn-block btn-xs btn-link toggle toggle-deselect toggle-{{ 'all' if loop.last else 'column' }}" value="none" />
                            </td>
                            {% endfor %}

                            <td></td>
                        </tr>
                    </table>
                </div>

                <div class="form-actions">
                    <a href="javascript: history.back();" class="btn btn-default">Back</a>
                    <input type="submit" value="Save" class="btn btn-primary" />
                </div>

            </form>
        {% endif %}
    {% endif %}
{% endblock %}
